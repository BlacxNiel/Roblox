local G=game
local S=G.GetService
local P=S(G,"Players")
local L=P.LocalPlayer
local W=S(G,"Workspace")
local U=S(G,"UserInputService")
local R=S(G,"RunService")

local E=true
local T=false
local F=Color3.fromRGB(255,105,180)
local O=Color3.fromRGB(255,150,200)

local function S1(c,p)
    if not E or (T and p.Team==L.Team) then return end
    if c:FindFirstChild("HL") then return end
    local h=Instance.new("Highlight")
    h.Name="HL"
    h.Parent=c
    h.FillColor=F
    h.OutlineColor=O
    h.FillTransparency=.5
    h.OutlineTransparency=0
end

local function R1(c)
    local h=c:FindFirstChild("HL")
    if h then h:Destroy() end
end

local function A(p)
    p.CharacterAdded:Connect(function(c)
        local h=c:WaitForChild("Humanoid")
        if h.Health>0 then S1(c,p) end
        h.Died:Connect(function() R1(c) end)
    end)
    local c=p.Character
    if c then S1(c,p) end
end

for _,p2 in next,P:GetPlayers() do if p2~=L then A(p2) end end
P.PlayerAdded:Connect(A)
P.PlayerRemoving:Connect(function(p2)
    local c=p2.Character
    if c then R1(c) end
end)

U.InputBegan:Connect(function(i,g)
    if not g and i.KeyCode==Enum.KeyCode.F4 and U:IsKeyDown(Enum.KeyCode.LeftControl) then
        E=not E
        for _,p2 in next,P:GetPlayers() do
            if p2~=L then
                local c=p2.Character
                if c then
                    if E then S1(c,p2) else R1(c) end
                end
            end
        end
    end
end)

local p=L
local s=getgenv().Settings or {Korblox=true,Headless=false,FOV=120}

local legs={"Right Leg","RightUpperLeg","RightLowerLeg","RightFoot"}

local function a()
    local c=p.Character or p.CharacterAdded:Wait()
    if s.Korblox then
        for _,n in next,legs do
            local x=c:FindFirstChild(n)
            if x then
                x.Transparency=1
                for _,o in next,x:GetChildren() do
                    local t=o.ClassName
                    if t=="Mesh" or t=="SpecialMesh" then o:Destroy() end
                end
            end
        end
    end
    if s.Headless then
        local h=c:FindFirstChild("Head")
        if h then
            h.Transparency=1
            for _,v in next,h:GetChildren() do
                local t=v.ClassName
                if t=="Decal" or t=="SpecialMesh" then v:Destroy() end
            end
        end
    end
    local cam=W.CurrentCamera
    if cam then cam.FieldOfView=s.FOV end
end

p.CharacterAdded:Connect(function()
    task.wait(.15)
    a()
end)

if p.Character then a() end

local ref=cloneref or function(x) return x end
local Plrs=ref(P)
local UIS=ref(U)
local RS=ref(R)
local Wk=ref(W)

local plr=Plrs.LocalPlayer
local enabled=false
local rotCon,oldAR

local yAxis=Vector3.yAxis
local offset=CFrame.new(1.8,0,0)

local function getParts()
    local c=plr.Character or plr.CharacterAdded:Wait()
    return c:WaitForChild("Humanoid"),c:WaitForChild("HumanoidRootPart")
end

local function lockMouse(v)
    if UIS.MouseEnabled then
        UIS.MouseBehavior=v and Enum.MouseBehavior.LockCenter or Enum.MouseBehavior.Default
    end
end

local function faceCam(h,hrp,state)
    if rotCon then
        rotCon:Disconnect()
        rotCon=nil
    end
    if state then
        oldAR=h.AutoRotate
        h.AutoRotate=false
        rotCon=RS.RenderStepped:Connect(function()
            local cam=Wk.CurrentCamera
            if not cam then return end
            local cf=cam.CFrame
            local lv=cf.LookVector
            local fx,fz=lv.X,lv.Z
            if fx~=0 or fz~=0 then
                hrp.CFrame=CFrame.lookAt(
                    hrp.Position,
                    Vector3.new(hrp.Position.X+fx,hrp.Position.Y,hrp.Position.Z+fz),
                    yAxis
                )
            end
            cam.CFrame=cf*offset
        end)
    else
        if oldAR~=nil then
            h.AutoRotate=oldAR
        end
    end
end

local function apply(v)
    enabled=v
    local h,hrp=getParts()
    lockMouse(v)
    faceCam(h,hrp,v)
end

UIS.InputBegan:Connect(function(i,g)
    if not g and i.KeyCode==Enum.KeyCode.P then
        apply(not enabled)
    end
end)

plr.CharacterAdded:Connect(function()
    task.defer(function()
        apply(enabled)
    end)
end)

local last=Wk.CurrentCamera
Wk:GetPropertyChangedSignal("CurrentCamera"):Connect(function()
    local c=Wk.CurrentCamera
    if c~=last then
        last=c
        apply(enabled)
    end
end)