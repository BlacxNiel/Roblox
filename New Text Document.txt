local P=game:GetService("Players")
local L=P.LocalPlayer
local E=true
local T=false
local F=Color3.fromRGB(255,105,180)
local O=Color3.fromRGB(255,150,200)

local function S(c,p)
    if not E or (T and p.Team==L.Team) or c:FindFirstChild("HL") then return end
    local h=Instance.new("Highlight")
    h.Name="HL"
    h.Parent=c
    h.FillColor=F
    h.OutlineColor=O
    h.FillTransparency=.5
    h.OutlineTransparency=0
end

local function R(c)
    local h=c:FindFirstChild("HL")
    if h then h:Destroy() end
end

local function A(p)
    p.CharacterAdded:Connect(function(c)
        repeat task.wait() until c:FindFirstChild("Humanoid")
        if c.Humanoid.Health>0 then S(c,p) end
        c.Humanoid.Died:Connect(function() R(c) end)
    end)
    if p.Character then S(p.Character,p) end
end

for _,p in next,P:GetPlayers() do if p~=L then A(p) end end
P.PlayerAdded:Connect(A)
P.PlayerRemoving:Connect(function(p) if p.Character then R(p.Character) end end)

local u=game:GetService("UserInputService")
u.InputBegan:Connect(function(i,g)
    if not g and i.KeyCode==Enum.KeyCode.F4 and u:IsKeyDown(Enum.KeyCode.LeftControl) then
        E=not E
        for _,p in next,P:GetPlayers() do
            if p~=L and p.Character then
                if E then S(p.Character,p) else R(p.Character) end
            end
        end
    end
end)

local p=L
local s=getgenv().Settings or {Korblox=true,Headless=false,FOV=120}

local function a()
    local c=p.Character or p.CharacterAdded:Wait()
    if s.Korblox then
        for _,n in next,{"Right Leg","RightUpperLeg","RightLowerLeg","RightFoot"} do
            local x=rawget(c,n) or c:FindFirstChild(n)
            if x then
                x.Transparency=1
                for _,o in next,x:GetChildren() do
                    local t=o.ClassName
                    if t=="Mesh" or t=="SpecialMesh" then o:Destroy() end
                end
            end
        end
    end
    if s.Headless then
        local h=rawget(c,"Head") or c:FindFirstChild("Head")
        if h then
            h.Transparency=1
            for _,v in next,h:GetChildren() do
                local t=v.ClassName
                if t=="Decal" or t=="SpecialMesh" then v:Destroy() end
            end
        end
    end
    local w=workspace.CurrentCamera
    if w then w.FieldOfView=s.FOV or 120 end
end

p.CharacterAdded:Connect(function() task.wait(.2) a() end)
if p.Character then a() end

local ref = cloneref or function(x) return x end
local S2 = function(n) return ref(game:GetService(n)) end

local Plrs = S2("Players")
local UIS = S2("UserInputService")
local RS = S2("RunService")
local Wk = S2("Workspace")

local plr = Plrs.LocalPlayer
local enabled = false
local rotCon, oldAR

local yAxis = Vector3.yAxis
local offset = CFrame.new(1.8, 0, 0)

local function getParts()
	local c = plr.Character or plr.CharacterAdded:Wait()
	return c:WaitForChild("Humanoid"), c:WaitForChild("HumanoidRootPart")
end

local function lockMouse(v)
	if UIS.MouseEnabled then
		UIS.MouseBehavior = v and Enum.MouseBehavior.LockCenter or Enum.MouseBehavior.Default
	end
end

local function faceCam(h, hrp, state)
	if rotCon then
		rotCon:Disconnect()
		rotCon = nil
	end

	if state then
		oldAR = h.AutoRotate
		h.AutoRotate = false

		rotCon = RS.RenderStepped:Connect(function()
			local cam = Wk.CurrentCamera
			if not cam then return end
			local cf = cam.CFrame
			local lv = cf.LookVector
			local flatX, flatZ = lv.X, lv.Z
			if flatX ~= 0 or flatZ ~= 0 then
				hrp.CFrame = CFrame.lookAt(
					hrp.Position,
					Vector3.new(hrp.Position.X + flatX, hrp.Position.Y, hrp.Position.Z + flatZ)
				)
			end
			cam.CFrame = cf * offset
		end)
	else
		if oldAR ~= nil then
			h.AutoRotate = oldAR
		end
	end
end

local function apply(v)
	enabled = v
	local h, hrp = getParts()
	lockMouse(v)
	faceCam(h, hrp, v)
end

UIS.InputBegan:Connect(function(i, gpe)
	if not gpe and i.KeyCode == Enum.KeyCode.P then
		apply(not enabled)
	end
end)

plr.CharacterAdded:Connect(function()
	task.defer(function()
		apply(enabled)
	end)
end)

local lastCam = Wk.CurrentCamera
Wk:GetPropertyChangedSignal("CurrentCamera"):Connect(function()
	local c = Wk.CurrentCamera
	if c ~= lastCam then
		lastCam = c
		apply(enabled)
	end
end)